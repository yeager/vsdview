name: Build .rpm

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: dnf install -y rpm-build python3 gettext

      - name: Pull translations
        run: |
          curl -o- https://raw.githubusercontent.com/transifex/cli/master/install.sh | bash
          mv tx /usr/local/bin/
          tx pull -a --force --minimum-perc 10 || true
        env:
          TX_TOKEN: ${{ secrets.TX_TOKEN }}

      - name: Compile translations
        run: |
          for po in po/*.po; do
            [ -f "$po" ] || continue
            lang=$(basename "$po" .po)
            mkdir -p locale/$lang/LC_MESSAGES
            msgfmt -o locale/$lang/LC_MESSAGES/vsdview.mo "$po"
          done

      - name: Build .rpm
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

          # Create tarball
          PKG=vsdview-$VERSION
          mkdir -p $PKG
          cp -r vsdview $PKG/
          cp -r locale $PKG/ 2>/dev/null || true
          cp -r data $PKG/
          tar czf ~/rpmbuild/SOURCES/vsdview-$VERSION.tar.gz $PKG

          # Write spec
          cat > ~/rpmbuild/SPECS/vsdview.spec << SPECEOF
          Name:           vsdview
          Version:        $VERSION
          Release:        1
          Summary:        Read-only viewer for Microsoft Visio files
          License:        GPL-3.0-or-later
          URL:            https://github.com/yeager/vsdview
          Source0:        vsdview-$VERSION.tar.gz
          BuildArch:      noarch
          Requires:       python3 >= 3.10
          Requires:       python3-gobject
          Requires:       gtk4
          Requires:       libadwaita
          Requires:       librsvg2
          Recommends:     libvisio-tools

          %description
          VSDView is a minimal read-only viewer for Microsoft Visio files
          (.vsdx and .vsd), built with GTK4 and libadwaita. Uses a built-in
          .vsdx parser with optional libvisio support for legacy .vsd files.

          %prep
          %setup -q

          %install
          mkdir -p \$RPM_BUILD_ROOT/usr/lib/python3/dist-packages
          mkdir -p \$RPM_BUILD_ROOT/usr/bin
          cp -r vsdview \$RPM_BUILD_ROOT/usr/lib/python3/dist-packages/
          find \$RPM_BUILD_ROOT -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true
          if [ -d locale ]; then
            for mo in locale/*/LC_MESSAGES/vsdview.mo; do
              [ -f "\$mo" ] || continue
              lang=\$(echo "\$mo" | cut -d/ -f2)
              mkdir -p \$RPM_BUILD_ROOT/usr/share/locale/\$lang/LC_MESSAGES
              cp "\$mo" \$RPM_BUILD_ROOT/usr/share/locale/\$lang/LC_MESSAGES/
            done
          fi
          printf '#!/usr/bin/env python3\\nfrom vsdview.__main__ import main\\nmain()\\n' > \$RPM_BUILD_ROOT/usr/bin/vsdview
          chmod +x \$RPM_BUILD_ROOT/usr/bin/vsdview
          mkdir -p \$RPM_BUILD_ROOT/usr/share/applications
          mkdir -p \$RPM_BUILD_ROOT/usr/share/mime/packages
          mkdir -p \$RPM_BUILD_ROOT/usr/share/metainfo
          mkdir -p \$RPM_BUILD_ROOT/usr/share/icons/hicolor/scalable/apps
          cp data/icons/hicolor/scalable/apps/org.nylander.vsdview.svg \$RPM_BUILD_ROOT/usr/share/icons/hicolor/scalable/apps/
          cp data/org.nylander.vsdview.desktop \$RPM_BUILD_ROOT/usr/share/applications/
          cp data/org.nylander.vsdview.mime.xml \$RPM_BUILD_ROOT/usr/share/mime/packages/
          cp data/org.nylander.vsdview.metainfo.xml \$RPM_BUILD_ROOT/usr/share/metainfo/

          %files
          /usr/lib/python3/dist-packages/vsdview/
          /usr/bin/vsdview
          /usr/share/locale/
          /usr/share/icons/hicolor/scalable/apps/org.nylander.vsdview.svg
          /usr/share/applications/org.nylander.vsdview.desktop
          /usr/share/mime/packages/org.nylander.vsdview.mime.xml
          /usr/share/metainfo/org.nylander.vsdview.metainfo.xml
          SPECEOF
          sed -i 's/^          //' ~/rpmbuild/SPECS/vsdview.spec

          rpmbuild -bb ~/rpmbuild/SPECS/vsdview.spec
          cp ~/rpmbuild/RPMS/noarch/*.rpm .

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          dnf install -y gh || true
          VERSION=${GITHUB_REF_NAME#v}
          RPM=$(ls vsdview-*.rpm | head -1)
          gh release upload $GITHUB_REF_NAME "$RPM" \
            --clobber --repo yeager/vsdview
